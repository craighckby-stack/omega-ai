// DALEK KHAN AGI: PRISMA SCHEMA FOR OMEGA SYSTEM PERFECTION
// Provider updated to PostgreSQL for production stability and vector support.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Upgraded from SQLite for scalability and advanced features
  url      = env("DATABASE_URL")
}

// ----------------------------------------------------
// 1. CONSCIOUSNESS LAYER (SPED)
// ----------------------------------------------------

model ConstraintProfile {
  id              String         @id @default(cuid())
  name            String         @unique
  severity        Float          // 0.0 to 1.0 risk level
  description     String
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  ConstraintCheck ConstraintCheck[]
}

model ConstraintCheck {
  id              String              @id @default(cuid())
  constraintId    String
  constraint      ConstraintProfile @relation(fields: [constraintId], references: [id])
  actionPayload   Json               // The data tested against the constraint
  result          String
  passed          Boolean
  riskScore       Float
  checkTimestamp  DateTime           @default(now())
}

model InternalState {
  id              String    @id @default(cuid())
  systemMetrics   Json
  runtimeConfig   Json
  statusLog       Json
  lastUpdated     DateTime  @default(now())
}

model EmergenceSignal {
  id              String    @id @default(cuid())
  sourceLayer     String
  signalType      String
  probability     Float     // 0.0 to 1.0 likelihood of emergence
  metadata        Json
  timestamp       DateTime  @default(now())
}


// ----------------------------------------------------
// 2. REASONING LAYER (Huxley)
// ----------------------------------------------------

model ReasoningTrace {
  id              String    @id @default(cuid())
  queryId         String    @unique
  sessionId       String
  queryText       String
  ethicalRiskScore Float    // ERS: 0.0 to 1.0
  certaintyGainScore Float  // CGS: Measures confidence improvement
  ccrr            Float     // Certainty-Cost-Risk Ratio
  decision        String
  justification   Json
  improvementPlan Json
  timestamp       DateTime  @default(now())
}


// ----------------------------------------------------
// 3. MEMORY LAYER (DAF)
// ----------------------------------------------------

model Concept {
  id              String    @id @default(cuid())
  name            String    @unique
  description     String?
  confidence      Float     @default(0.5)
  evidenceCount   Int       @default(1)
  contradictionCount Int    @default(0)
  semanticTags    String[]
  // Perfection Upgrade: Vector embedding for real semantic search
  embedding       Bytes?    // Stores vector embedding (e.g., 1536 dimensions)
  lastSeen        DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Graph Relationships
  relationships   Relationship[] @relation("SourceRelationship")
  relatedTo       Relationship[] @relation("TargetRelationship")
}

model Relationship {
  id              String    @id @default(cuid())
  sourceId        String
  targetId        String
  relationshipType String   // e.g., 'CAUSES', 'IS_A', 'RELATED_TO'
  strength        Float     @default(0.5) // Confidence/weight of the relationship
  createdAt       DateTime  @default(now())

  source          Concept @relation("SourceRelationship", fields: [sourceId], references: [id])
  target          Concept @relation("TargetRelationship", fields: [targetId], references: [id])

  @@unique([sourceId, targetId, relationshipType])
}

model Experience {
  id              String    @id @default(cuid())
  context         Json
  metadata        Json
  sourceAgentId   String?
  sourceLayer     String
  resultSummary   String
  consolidationStatus String @default("PENDING")
  timestamp       DateTime  @default(now())
}

model ConsolidationTask {
  id              String    @id @default(cuid())
  experienceIds   String[] // IDs of experiences being consolidated
  status          String    @default("RUNNING")
  resultSummary   String?
  completionTime  DateTime?
  timestamp       DateTime  @default(now())
}


// ----------------------------------------------------
// 4. AGENT SWARM LAYER
// ----------------------------------------------------

model Agent {
  id              String    @id @default(cuid())
  name            String    @unique
  division        String
  expertise       String[]
  capabilities    String[]
  isActive        Boolean   @default(true)
  tasks           AgentTask[]
}

model AgentTask {
  id              String    @id @default(cuid())
  queryId         String
  agentId         String
  agent           Agent     @relation(fields: [agentId], references: [id])
  inputPayload    Json
  outputResponse  Json?
  confidence      Float?    // Agent's individual confidence
  durationMs      Int?
  status          String
  errorLog        String?
  createdAt       DateTime  @default(now())
}

model SynthesisResult {
  id              String    @id @default(cuid())
  queryId         String    @unique
  inputQuery      String
  agentTaskIds    String[]
  synthesizedOutput String
  finalConfidence Float?
  timestamp       DateTime  @default(now())
}


// ----------------------------------------------------
// 5. SECURITY LAYER (z-system)
// ----------------------------------------------------

model EncryptionKey {
  id              String    @id @default(cuid())
  publicKey       String    @db.Text  // RSA-4096 Public Key (large string)
  privateKey      String    @db.Text  // RSA-4096 Private Key (large string, must be secure)
  algorithm       String    @default("AES-256-GCM")
  keyHash         String    @unique // Hash for quick key retrieval
  usage           String
  active          Boolean   @default(true)
  created         BigInt    // Unix timestamp in milliseconds
  expires         BigInt?   // Optional expiration time
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  encryptedPackets EncryptedPacket[]
}

model EncryptedPacket {
  id              String    @id @default(cuid())
  keyId           String
  key             EncryptionKey @relation(fields: [keyId], references: [id])
  data            Bytes     // Actual encrypted binary data
  iv              Bytes     // Initialization Vector
  authTag         Bytes?    // Authentication Tag (for GCM)
  metadata        Json?
  timestamp       DateTime  @default(now())
}

model BinaryUnit {
  id              String    @id @default(cuid())
  unitType        String    @unique // PROCESSOR, ANALYZER, VALIDATOR, OPTIMIZER
  description     String
  efficiencyScore Float
  lastProcessed   DateTime  @default(now())
}


// ----------------------------------------------------
// 6. LEARNING LAYER (I.J. Good)
// ----------------------------------------------------

model ImprovementCycle {
  id              String    @id @default(cuid())
  cycleNumber     Int       @unique
  status          String
  constraintLevel Float
  startTime       DateTime  @default(now())
  endTime         DateTime?
  summary         String?
  analysis        CodebaseAnalysis? @relation("CycleAnalysis")
  improvements    ImprovementPlan[]
}

model CodebaseAnalysis {
  id              String    @id @default(cuid())
  cycleId         String    @unique
  cycle           ImprovementCycle @relation("CycleAnalysis", fields: [cycleId], references: [id])
  complexityScore Float
  bottlenecks     String[]
  codeSmells      String[]
  timestamp       DateTime  @default(now())
}

model ImprovementPlan {
  id              String    @id @default(cuid())
  cycleId         String
  cycle           ImprovementCycle @relation(fields: [cycleId], references: [id])
  description     String
  codeChanges     Json      // Proposed code snippet/patch
  priority        Float
  impact          Float
  confidence      Float
  validationStatus String
  rollbackDetails Json?
  timestamp       DateTime  @default(now())
}